#!/bin/bash
set -e  # ì—ëŸ¬ ë‚˜ë©´ ë°”ë¡œ ì¤‘ë‹¨

# ìƒ‰ìƒ (ê·¸ëƒ¥ ë³´ê¸° ì¢‹ê²Œ ì¶œë ¥ìš©)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘      ğŸš¨ Supabase LOCAL Recovery Script       â•‘${NC}"
echo -e "${BLUE}â•‘           (Production ì ˆëŒ€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)    â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# 1. LOCAL ê²½ë¡œ í™•ì¸
echo -e "${YELLOW}[1] LOCAL í™˜ê²½/ê²½ë¡œ í™•ì¸ ì¤‘...${NC}"

PROJECT_ROOT="/Users/kwonhyunjun/Desktop/pickly_service"
SUPABASE_DIR="$PROJECT_ROOT/supabase"   # âœ… ì‹¤ì œ êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì •

if [ ! -d "$SUPABASE_DIR" ]; then
  echo -e "${RED}âŒ ERROR: Supabase ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $SUPABASE_DIR${NC}"
  exit 1
fi

cd "$SUPABASE_DIR"
echo -e "${GREEN}âœ… LOCAL Supabase ë””ë ‰í† ë¦¬ í™•ì¸ ì™„ë£Œ${NC}"
echo "   í˜„ì¬ ìœ„ì¹˜: $(pwd)"
echo ""

# 2. Supabase ì¤‘ì§€
echo -e "${YELLOW}[2] Supabase ì¤‘ì§€ (ë¡œì»¬ë§Œ)â€¦${NC}"
supabase stop || echo "âš ï¸ í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ Supabase ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤."
echo -e "${GREEN}âœ… Supabase stop ì²˜ë¦¬ ì™„ë£Œ${NC}"
echo ""

# 3. Supabase ê´€ë ¨ Docker ì»¨í…Œì´ë„ˆ ì œê±°
echo -e "${YELLOW}[3] Supabase ê´€ë ¨ Docker ì»¨í…Œì´ë„ˆ ì œê±°â€¦${NC}"
docker ps -a --format '{{.ID}}\t{{.Names}}' | grep supabase || echo "â„¹ï¸ supabase ì´ë¦„ì´ í¬í•¨ëœ ì»¨í…Œì´ë„ˆ ì—†ìŒ"
docker ps -a --format '{{.ID}}\t{{.Names}}' | grep supabase | awk '{print $1}' | xargs -r docker rm -f 2>/dev/null || true
echo -e "${GREEN}âœ… Supabase ì»¨í…Œì´ë„ˆ ì œê±° ì™„ë£Œ${NC}"
echo ""

# 4. Supabase ê´€ë ¨ Docker ë³¼ë¥¨ ì œê±°
echo -e "${YELLOW}[4] Supabase ê´€ë ¨ Docker ë³¼ë¥¨ ì œê±°â€¦${NC}"
docker volume ls --format '{{.Name}}' | grep supabase || echo "â„¹ï¸ supabase ì´ë¦„ì´ í¬í•¨ëœ ë³¼ë¥¨ ì—†ìŒ"
docker volume ls --format '{{.Name}}' | grep supabase | xargs -r docker volume rm 2>/dev/null || true
echo -e "${GREEN}âœ… Supabase ë³¼ë¥¨ ì œê±° ì™„ë£Œ${NC}"
echo ""

# 5. migrations ì •ë¦¬ (.disabled ë° ì´ìƒí•œ íŒŒì¼ ë°±ì—…)
echo -e "${YELLOW}[5] migrations í´ë” ì •ë¦¬â€¦${NC}"

MIGRATIONS_DIR="$SUPABASE_DIR/migrations"

if [ ! -d "$MIGRATIONS_DIR" ]; then
  echo -e "${RED}âŒ ERROR: migrations ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $MIGRATIONS_DIR${NC}"
  exit 1
fi

cd "$MIGRATIONS_DIR"

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR=".backup_${TIMESTAMP}"

mkdir -p "$BACKUP_DIR"

# 5-1) *.disabled* íŒŒì¼ë“¤ ë°±ì—… í´ë”ë¡œ ì´ë™
find . -maxdepth 1 -name "*.disabled*" -exec mv {} "$BACKUP_DIR/" \; 2>/dev/null || true

# 5-2) íŒŒì¼ëª…ì´ "14ìë¦¬ìˆ«ì_ì´ë¦„.sql" í˜•ì‹ì´ ì•„ë‹Œ .sql ë“¤ë„ ë°±ì—…ìœ¼ë¡œ ì´ë™
find . -maxdepth 1 -name "*.sql" ! -name "[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]_*.sql" -exec mv {} "$BACKUP_DIR/" \; 2>/dev/null || true

echo -e "${GREEN}âœ… migrations ì •ë¦¬ ì™„ë£Œ (ë°±ì—…: $MIGRATIONS_DIR/$BACKUP_DIR)${NC}"
echo ""

cd "$SUPABASE_DIR"

# 6. seed.sql ì•ˆì „í•˜ê²Œ ì´ˆê¸°í™”
echo -e "${YELLOW}[6] seed.sql ì •ë¦¬ (ìœ„í—˜í•œ ë‚´ìš© ì œê±°)â€¦${NC}"

cat > seed.sql << 'SEEDEOF'
-- Pickly LOCAL ê°œë°œìš© seed íŒŒì¼
-- âš ï¸ ì—¬ê¸°ì„œëŠ” ìœ„í—˜í•œ admin ìƒì„±/í† í° ì¡°ì‘ ë“±ì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
-- í•„ìš”í•˜ë©´ ë‚˜ì¤‘ì— ê°œë³„ insert ìŠ¤í¬ë¦½íŠ¸ë¡œ ì¶”ê°€í•˜ì„¸ìš”.

-- ì˜ˆì‹œ: ì—°ë ¹ëŒ€/í…ŒìŠ¤íŠ¸ìš© ë°ì´í„°ëŠ” ë³„ë„ migration ë˜ëŠ” admin UIì—ì„œ ê´€ë¦¬.
SEEDEOF

echo -e "${GREEN}âœ… seed.sql ì´ˆê¸°í™” ì™„ë£Œ${NC}"
echo ""

# 7. Supabase ë¡œì»¬ ìƒˆë¡œ ì‹œì‘
echo -e "${YELLOW}[7] Supabase ë¡œì»¬ ì¸ìŠ¤í„´ìŠ¤ ìƒˆë¡œ ì‹œì‘â€¦${NC}"
supabase start
echo -e "${GREEN}âœ… Supabase ë¡œì»¬ ì‹œì‘ ì™„ë£Œ${NC}"
echo ""

# 8. auth.users êµ¬ì¡° í™•ì¸
echo -e "${YELLOW}[8] auth.users ì»¬ëŸ¼ êµ¬ì¡° í™•ì¸â€¦${NC}"
docker exec supabase_db_supabase psql -U postgres -d postgres -c "
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_schema = 'auth' 
  AND table_name   = 'users'
  AND column_name IN (
    'confirmation_token',
    'recovery_token',
    'email_change_token_new',
    'email_change_token_current',
    'reauthentication_token'
  );
" || echo -e "${RED}âŒ auth.users êµ¬ì¡° í™•ì¸ ì‹¤íŒ¨ (ì»¨í…Œì´ë„ˆ ì´ë¦„ í˜¹ì€ DB í™•ì¸ í•„ìš”)${NC}"
echo ""

# 9. admin@pickly.com ì¡´ì¬ ì—¬ë¶€ í™•ì¸
echo -e "${YELLOW}[9] admin@pickly.com ì‚¬ìš©ì ì¡´ì¬/í† í° í™•ì¸â€¦${NC}"
docker exec supabase_db_supabase psql -U postgres -d postgres -c "
SELECT 
  email,
  confirmation_token,
  recovery_token,
  email_change_token_new,
  email_change_token_current,
  reauthentication_token,
  email_confirmed_at IS NOT NULL AS confirmed
FROM auth.users
WHERE email = 'admin@pickly.com';
" 2>/dev/null || echo "âš ï¸ admin@pickly.com ì¡°íšŒ ì‹¤íŒ¨ (ì•„ì§ ìƒì„± ì „ì¼ ìˆ˜ë„ ìˆìŒ)"
echo ""

# 10. admin í† í° NULL â†’ '' ë¡œ ì•ˆì „í•˜ê²Œ ì¹˜í™˜
echo -e "${YELLOW}[10] admin@pickly.com í† í° NULL â†’ '' ì¹˜í™˜â€¦${NC}"
docker exec supabase_db_supabase psql -U postgres -d postgres -c "
UPDATE auth.users
SET
  confirmation_token      = COALESCE(confirmation_token, ''),
  recovery_token          = COALESCE(recovery_token, ''),
  email_change_token_new  = COALESCE(email_change_token_new, ''),
  email_change_token_current = COALESCE(email_change_token_current, ''),
  reauthentication_token  = COALESCE(reauthentication_token, '')
WHERE email = 'admin@pickly.com';
" 2>/dev/null || echo "âš ï¸ admin í† í° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ (ì¡´ì¬í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ)"
echo -e "${GREEN}âœ… í† í° NULL â†’ '' ì²˜ë¦¬ ì‹œë„ ì™„ë£Œ${NC}"
echo ""

# 11. Storage buckets í™•ì¸
echo -e "${YELLOW}[11] Storage buckets í™•ì¸â€¦${NC}"
docker exec supabase_db_supabase psql -U postgres -d postgres -c "
SELECT id, name, public 
FROM storage.buckets 
WHERE name IN ('benefit-images', 'benefit-documents', 'announcement-thumbnails')
ORDER BY name;
" || echo "âš ï¸ storage.buckets ì¡°íšŒ ì‹¤íŒ¨"
echo ""

# 12. RPC í•¨ìˆ˜ í™•ì¸
echo -e "${YELLOW}[12] RPC í•¨ìˆ˜ save_announcement_with_details ì¡´ì¬ ì—¬ë¶€ í™•ì¸â€¦${NC}"
docker exec supabase_db_supabase psql -U postgres -d postgres -c "
SELECT proname 
FROM pg_proc 
WHERE proname = 'save_announcement_with_details';
" || echo "âš ï¸ RPC í•¨ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨"
echo ""

# 13. ìµœì¢… ìƒíƒœ ì¶œë ¥
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘        âœ… Supabase LOCAL ë³µêµ¬ ìŠ¤í¬ë¦½íŠ¸ ì™„ë£Œ   â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${GREEN}ğŸ“Š Supabase status:${NC}"
supabase status || echo "âš ï¸ supabase status ì—ëŸ¬ (CLI ë˜ëŠ” Docker ìƒíƒœ í™•ì¸ í•„ìš”)"
echo ""
echo -e "${GREEN}ğŸ“Œ ë‹¤ìŒ ì²´í¬ë¥¼ í•´ë³´ì„¸ìš”:${NC}"
echo "1) ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:5192 ì ‘ì†"
echo "2) admin@pickly.com / pickly2025! ë¡œê·¸ì¸ ì‹œë„"
echo ""
echo -e "${YELLOW}ì¶”ê°€ health check (ì›í•˜ë©´ ìˆ˜ë™ ì‹¤í–‰):${NC}"
echo "docker exec supabase_db_supabase psql -U postgres -d postgres -c \"SELECT email, confirmation_token, email_confirmed_at FROM auth.users WHERE email = 'admin@pickly.com';\""
echo ""
