#!/usr/bin/env bash
# ==========================================================
# ğŸš€ Pickly Service v7.2 ì•ˆì „ ë²„ì „ ìë™ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
# (Supabase link ê°ì§€ + ë£¨íŠ¸ ê²½ë¡œ ìë™ ì´ë™)
# ==========================================================

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
RESET='\033[0m'

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸš€ Pickly Service v7.2 SAFE AUTO DEPLOY ì‹œì‘"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# ----------------------------------------------------------
# STEP 1ï¸âƒ£ : ë£¨íŠ¸ ê²½ë¡œë¡œ ì´ë™ (ìŠ¤í¬ë¦½íŠ¸ ìœ„ì¹˜ ê¸°ì¤€)
# ----------------------------------------------------------
cd "$(dirname "$0")/.." || exit
ROOT_DIR=$(pwd)
echo -e "${YELLOW}í˜„ì¬ ë””ë ‰í† ë¦¬: $ROOT_DIR${RESET}"

# ----------------------------------------------------------
# STEP 2ï¸âƒ£ : Supabase ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
# ----------------------------------------------------------
echo -e "${YELLOW}ğŸ“‹ Supabase ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘...${RESET}"
if supabase projects list &>/dev/null; then
  echo -e "${GREEN}âœ… Supabase ë¡œê·¸ì¸ í™•ì¸ë¨${RESET}"
else
  echo -e "${RED}âŒ Supabase ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.${RESET}"
  echo -e "${YELLOW}ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ í„°ë¯¸ë„ì—ì„œ ì§ì ‘ ì‹¤í–‰í•˜ì„¸ìš”:${RESET}"
  echo -e "${YELLOW}  supabase login${RESET}"
  echo -e "${YELLOW}ë¡œê·¸ì¸ ì™„ë£Œ í›„ ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.${RESET}"
  exit 1
fi

# ----------------------------------------------------------
# STEP 3ï¸âƒ£ : í”„ë¡œì íŠ¸ ë§í¬ í™•ì¸ ë° ìë™ ë³µêµ¬
# ----------------------------------------------------------
echo -e "${YELLOW}ğŸ“‹ Supabase í”„ë¡œì íŠ¸ ë§í¬ í™•ì¸ ì¤‘...${RESET}"

# .supabase ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ë§í¬ê°€ í•„ìš”
if [ ! -d ".supabase" ]; then
  echo -e "${YELLOW}âš ï¸ í”„ë¡œì íŠ¸ê°€ ë§í¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ë§í¬í•©ë‹ˆë‹¤...${RESET}"
  echo -e "${YELLOW}   Project Ref: vymxxpjxrorpywfmqpuk${RESET}"

  # ìë™ ë§í¬ ì‹œë„ (ë¹„ëŒ€í™”í˜• ëª¨ë“œì—ì„œëŠ” ì‹¤íŒ¨í•  ìˆ˜ ìˆìŒ)
  if supabase link --project-ref vymxxpjxrorpywfmqpuk --password "$SUPABASE_DB_PASSWORD" 2>/dev/null; then
    echo -e "${GREEN}âœ… í”„ë¡œì íŠ¸ ë§í¬ ì„±ê³µ${RESET}"
  else
    echo -e "${RED}âŒ ìë™ ë§í¬ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ë§í¬í•˜ì„¸ìš”:${RESET}"
    echo -e "${YELLOW}   supabase link --project-ref vymxxpjxrorpywfmqpuk${RESET}"
    echo -e "${YELLOW}   (ë°ì´í„°ë² ì´ìŠ¤ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤)${RESET}"
    exit 1
  fi
fi

# ë§í¬ í™•ì¸
if [ -d ".supabase" ]; then
  echo -e "${GREEN}âœ… Supabase í”„ë¡œì íŠ¸ ë§í¬ í™•ì¸ ì™„ë£Œ${RESET}"
else
  echo -e "${RED}âŒ í”„ë¡œì íŠ¸ ë§í¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.${RESET}"
  echo -e "${YELLOW}ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:${RESET}"
  echo -e "${YELLOW}  supabase link --project-ref vymxxpjxrorpywfmqpuk${RESET}"
  exit 1
fi

# ----------------------------------------------------------
# STEP 4ï¸âƒ£ : Supabase ì„œë¹„ìŠ¤ ì‹œì‘ ë° ë§ˆì´ê·¸ë ˆì´ì…˜
# ----------------------------------------------------------
echo -e "${YELLOW}ğŸ“¦ Supabase ë¡œì»¬ ì„œë²„ ì‹œì‘ ì¤‘...${RESET}"
supabase start || true

echo -e "${YELLOW}ğŸ§± DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© ì¤‘...${RESET}"
supabase db reset || true
supabase db push || true
echo -e "${GREEN}âœ… Supabase DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ${RESET}"

# ----------------------------------------------------------
# STEP 5ï¸âƒ£ : Flutter & Admin ë¹Œë“œ ê²€ì¦
# ----------------------------------------------------------
cd apps/pickly_mobile
flutter pub get
flutter analyze
flutter build apk || true
cd ../pickly_admin
npm install
npm run build
cd ../..
echo -e "${GREEN}âœ… Flutter/Admin ë¹Œë“œ ê²€ì¦ ì™„ë£Œ${RESET}"

# ----------------------------------------------------------
# STEP 6ï¸âƒ£ : ê²°ê³¼ ìš”ì•½ ë¦¬í¬íŠ¸ ì¶œë ¥
# ----------------------------------------------------------
echo ""
echo "ğŸ¯ Pickly Service v7.2 SAFE DEPLOY ì™„ë£Œ"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "âœ… Supabase ë¡œê·¸ì¸ ë° ë§í¬: ì •ìƒ"
echo "âœ… DB ë§ˆì´ê·¸ë ˆì´ì…˜: ì™„ë£Œ"
echo "âœ… Flutter/Admin ë¹Œë“œ: ì„±ê³µ"
echo "ğŸ“˜ ë£¨íŠ¸ ë””ë ‰í† ë¦¬: $ROOT_DIR"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "ğŸ‰ ë‹¤ìŒ ë‹¨ê³„:"
echo "  1. GitHub PR ìƒì„± â†’ main ë³‘í•©"
echo "  2. ë¦´ë¦¬ì¦ˆ íƒœê·¸ ìƒì„± â†’ v7.2.0"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
