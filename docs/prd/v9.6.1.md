# Pickly PRD v9.6.1 - Announcement Tabs System

## Overview
Extension to the announcement management system that adds optional tab-based structure for complex announcements (e.g., LH housing with multiple floor plan types).

## Release Information
- **Version**: v9.6.1
- **Release Date**: 2025-11-16
- **Type**: Database Extension (Backend Only)
- **Breaking Changes**: None

## Purpose
This extension enables announcements to organize detailed information into multiple tabs, each containing:
- Text content sections (title + body)
- Images with captions
- Structured floor plan information

## Database Schema

### Table 1: `announcement_tabs`
**Note**: This table already existed from a previous migration. The extension adds new child tables.

Stores tab information for announcements.

```sql
CREATE TABLE public.announcement_tabs (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  announcement_id uuid NOT NULL REFERENCES announcements(id) ON DELETE CASCADE,
  tab_name text NOT NULL,
  age_category_id uuid REFERENCES age_categories(id),
  unit_type text,
  floor_plan_image_url text,
  supply_count integer,
  income_conditions jsonb,
  additional_info jsonb,
  display_order integer NOT NULL DEFAULT 0,
  created_at timestamptz DEFAULT now()
);
```

### Table 2: `announcement_tab_contents` (NEW)
Stores text content sections for each tab.

```sql
CREATE TABLE public.announcement_tab_contents (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tab_id uuid NOT NULL REFERENCES announcement_tabs(id) ON DELETE CASCADE,
  section_title text,
  section_body text,
  sort_order integer DEFAULT 0,
  created_at timestamptz DEFAULT now()
);
```

### Table 3: `announcement_tab_images` (NEW)
Stores images for each tab.

```sql
CREATE TABLE public.announcement_tab_images (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  tab_id uuid NOT NULL REFERENCES announcement_tabs(id) ON DELETE CASCADE,
  image_url text NOT NULL,
  caption text,
  sort_order integer DEFAULT 0,
  created_at timestamptz DEFAULT now()
);
```

## RPC Function

### `save_announcement_tabs(p_announcement_id uuid, p_tabs jsonb)`
Atomically saves/updates all tabs for a specific announcement.

**Behavior**:
1. Deletes all existing tabs for the announcement (CASCADE deletes contents/images)
2. Inserts new tabs with their contents and images
3. Maintains referential integrity across all 3 tables

**Input Format**:
```jsonb
[
  {
    "title": "84㎡A",
    "sort_order": 0,
    "contents": [
      {
        "section_title": "공급 정보",
        "section_body": "총 50세대 공급",
        "sort_order": 0
      }
    ],
    "images": [
      {
        "image_url": "https://example.com/floor-plan.jpg",
        "caption": "평면도",
        "sort_order": 0
      }
    ]
  }
]
```

**Usage Example**:
```sql
SELECT save_announcement_tabs(
  '1c1fb8be-5d48-463c-9aaa-f71a7fcd8210'::uuid,
  '[
    {
      "title": "84㎡A",
      "sort_order": 0,
      "contents": [...],
      "images": [...]
    }
  ]'::jsonb
);
```

## Migration Files

### Migration: `202511160001_add_announcement_tabs.sql`
Location: `backend/supabase/migrations/202511160001_add_announcement_tabs.sql`

Creates:
- `announcement_tab_contents` table
- `announcement_tab_images` table
- Indexes for performance
- RLS policies for security
- Permissions for authenticated users

### RPC Script: `create_or_update_announcement_tabs.sql`
Location: `backend/supabase/scripts/rpc/create_or_update_announcement_tabs.sql`

Creates the `save_announcement_tabs` function with proper error handling.

## Testing

### Test Results
✅ Migration executed successfully on local database
✅ All 3 tables created with proper foreign keys
✅ RPC function created and tested
✅ Sample data inserted successfully:
  - 2 tabs created
  - 2 tab contents created
  - 1 tab image created

### Manual Testing
```sql
-- Verify tables exist
\d public.announcement_tabs
\d public.announcement_tab_contents
\d public.announcement_tab_images

-- Verify RPC function
\df public.save_announcement_tabs

-- Test with sample data
SELECT save_announcement_tabs(...);
```

## Security

### Row Level Security (RLS)
All tables have RLS enabled with policies:
- **Authenticated users**: Full CRUD access (Admin only)
- **Public users**: Read-only access (for mobile app)

### Permissions
- `authenticated` role: All operations
- `service_role` role: All operations
- `anon` role: SELECT only (implicit via RLS)

## Impact Analysis

### Breaking Changes
❌ None - This is a pure extension

### Existing Functionality
✅ No modifications to existing tables
✅ No modifications to existing RPCs
✅ No impact on Admin UI (tabs system is optional)
✅ No impact on Mobile App (existing announcements continue to work)

### Future Enhancements
The tabs system is designed to be extended in the Admin UI in a future release to support:
- Tab-based announcement editing
- Floor plan upload per tab
- Age category filtering per tab
- Income condition management per tab

## Deployment Checklist

- [x] Migration file created
- [x] RPC file created
- [x] Migration tested on local database
- [x] RPC function tested with sample data
- [x] Tables verified with correct schema
- [x] Foreign keys and CASCADE working correctly
- [x] RLS policies applied
- [x] Permissions granted
- [x] Documentation updated

## Next Steps

1. **Admin UI Integration** (Future Release)
   - Add tab management UI to AnnouncementManager.tsx
   - Implement tab content editor
   - Add image upload per tab

2. **Mobile App Integration** (Future Release)
   - Display tabs in announcement detail view
   - Tab navigation UI
   - Image gallery per tab

## Files Modified/Created

### Created
- `backend/supabase/migrations/202511160001_add_announcement_tabs.sql`
- `backend/supabase/scripts/rpc/create_or_update_announcement_tabs.sql`
- `docs/prd/v9.6.1.md` (this file)

### Modified
- None (extension only)

## Version History

| Version | Date | Changes |
|---------|------|---------|
| v9.6.1 | 2025-11-16 | Initial release - Announcement tabs database schema |

---

**Status**: ✅ Complete (Database Only)
**Next Phase**: Admin UI Integration (TBD)
