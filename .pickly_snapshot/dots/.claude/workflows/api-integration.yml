---
name: api-integration
description: ë„ë©”ì¸ë³„ API í†µí•© ìë™í™” ì›Œí¬í”Œë¡œìš° (ê¸°ì¡´ ì½”ë“œ ë³´í˜¸)
version: 1.0.0
priority: high

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
triggers:
  - manual  # ìˆ˜ë™ ì‹¤í–‰ë§Œ í—ˆìš©
  - command: "api-integration phase <1|2>"

# í™˜ê²½ ë³€ìˆ˜
environment:
  project_root: "apps/pickly_mobile"
  protected_paths:
    - "lib/contexts/user/**"
    - "lib/contexts/benefit/**"
    - "lib/features/onboarding/**"
    - "lib/features/benefits/**"
    - "lib/core/router.dart"
    - "lib/core/supabase_config.dart"
    - "packages/pickly_design_system/**"

# Phase 1: ê³µí†µ ì¸í”„ë¼ êµ¬ì¶•
phases:
  - id: phase-1
    name: "ê³µí†µ API ì¸í”„ë¼ êµ¬ì¶•"
    description: "Dio í´ë¼ì´ì–¸íŠ¸, ì—ëŸ¬ í•¸ë“¤ë§, ì¸í„°ì…‰í„° ìƒì„±"

    agents:
      - type: api-integration-builder
        role: specialist
        tasks:
          - name: "API ì„¤ì • íŒŒì¼ ìƒì„±"
            description: "core/network/api_config.dart ìƒì„±"
            output: "lib/core/network/api_config.dart"
            template: "agent_spec:lines:73-97"

          - name: "Dio í´ë¼ì´ì–¸íŠ¸ íŒ©í† ë¦¬ ìƒì„±"
            description: "core/network/api_client.dart ìƒì„±"
            output: "lib/core/network/api_client.dart"
            template: "agent_spec:lines:100-147"

          - name: "API ì¸í„°ì…‰í„° ìƒì„±"
            description: "core/network/api_interceptor.dart ìƒì„±"
            output: "lib/core/network/api_interceptor.dart"
            template: |
              import 'package:dio/dio.dart';

              class ApiInterceptor extends Interceptor {
                @override
                void onRequest(RequestOptions options, RequestInterceptorHandler handler) {
                  print('ğŸŒ API Request: ${options.method} ${options.path}');
                  print('ğŸ“¦ Query Params: ${options.queryParameters}');
                  super.onRequest(options, handler);
                }

                @override
                void onResponse(Response response, ResponseInterceptorHandler handler) {
                  print('âœ… API Response: ${response.statusCode} ${response.requestOptions.path}');
                  super.onResponse(response, handler);
                }

                @override
                void onError(DioException err, ErrorInterceptorHandler handler) {
                  print('âŒ API Error: ${err.requestOptions.path}');
                  print('âŒ Error Message: ${err.message}');
                  super.onError(err, handler);
                }
              }

          - name: "ì»¤ìŠ¤í…€ ì—ëŸ¬ í´ë˜ìŠ¤ ìƒì„±"
            description: "core/errors/api_exception.dart ìƒì„±"
            output: "lib/core/errors/api_exception.dart"
            template: |
              class ApiException implements Exception {
                final String message;
                final int? statusCode;
                final dynamic data;

                ApiException({
                  required this.message,
                  this.statusCode,
                  this.data,
                });

                @override
                String toString() => 'ApiException: $message (Status: $statusCode)';
              }

              class NetworkException extends ApiException {
                NetworkException({required super.message}) : super(statusCode: 0);
              }

              class ServerException extends ApiException {
                ServerException({required super.message, super.statusCode});
              }

    validations:
      - type: file-exists
        files:
          - "lib/core/network/api_config.dart"
          - "lib/core/network/api_client.dart"
          - "lib/core/network/api_interceptor.dart"
          - "lib/core/errors/api_exception.dart"

      - type: flutter-analyze
        command: "cd apps/pickly_mobile && flutter analyze"
        expect: "No issues found"

      - type: protected-files-unchanged
        paths: "${environment.protected_paths}"
        error_message: "ê¸°ì¡´ ì½”ë“œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! ë¡¤ë°± í•„ìš”"

  # Phase 2: LH API í†µí•©
  - id: phase-2
    name: "ì£¼ê±° ë„ë©”ì¸ LH API í†µí•©"
    description: "LH ê³µì‚¬ API ëª¨ë¸, Repository, Provider, UI ìƒì„±"
    depends_on: phase-1

    agents:
      - type: api-integration-builder
        role: specialist
        tasks:
          - name: "LH ê³µê³  ëª¨ë¸ ìƒì„±"
            description: "contexts/housing/models/lh_announcement.dart ìƒì„±"
            output: "lib/contexts/housing/models/lh_announcement.dart"

          - name: "LH Repository ìƒì„±"
            description: "contexts/housing/repositories/lh_repository.dart ìƒì„±"
            output: "lib/contexts/housing/repositories/lh_repository.dart"

          - name: "Housing Provider ìƒì„±"
            description: "features/housing/providers/housing_provider.dart ìƒì„±"
            output: "lib/features/housing/providers/housing_provider.dart"

          - name: "Housing List Screen ìƒì„±"
            description: "features/housing/screens/housing_list_screen.dart ìƒì„±"
            output: "lib/features/housing/screens/housing_list_screen.dart"

    validations:
      - type: file-exists
        files:
          - "lib/contexts/housing/models/lh_announcement.dart"
          - "lib/contexts/housing/repositories/lh_repository.dart"
          - "lib/features/housing/providers/housing_provider.dart"
          - "lib/features/housing/screens/housing_list_screen.dart"

      - type: flutter-test
        command: "cd apps/pickly_mobile && flutter test"
        expect: "All tests passed"

      - type: protected-files-unchanged
        paths: "${environment.protected_paths}"
        error_message: "ê¸°ì¡´ ì½”ë“œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! ë¡¤ë°± í•„ìš”"

# ì„±ê³µ ê¸°ì¤€
success_criteria:
  phase-1:
    - "flutter pub get ì„±ê³µ"
    - "flutter analyze ì—ëŸ¬ ì—†ìŒ"
    - "ê¸°ì¡´ ì˜¨ë³´ë”© í™”ë©´ ì •ìƒ ì‘ë™"
    - "ê¸°ì¡´ í˜œíƒ í™”ë©´ ì •ìƒ ì‘ë™ (9ê°œ ì¹´í…Œê³ ë¦¬)"

  phase-2:
    - "LH Repository API í˜¸ì¶œ ì„±ê³µ"
    - "LhAnnouncement ëª¨ë¸ JSON íŒŒì‹± ì„±ê³µ"
    - "housing_list_screen ë°ì´í„° í‘œì‹œ"
    - "ì—ëŸ¬ ë°œìƒ ì‹œ ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€ í‘œì‹œ"
    - "ê¸°ì¡´ ëª¨ë“  ê¸°ëŠ¥ ì •ìƒ ì‘ë™"

# ë¡¤ë°± ì „ëµ
rollback:
  - step: "Git stash ìƒì„±ëœ íŒŒì¼ë“¤"
    command: "git stash push -m 'rollback api integration'"
  - step: "ë³´í˜¸ëœ íŒŒì¼ ë³µì›"
    command: "git checkout HEAD -- ${environment.protected_paths}"
  - step: "ì•± ì¬ì‹œì‘ ë° í™•ì¸"
    command: "flutter run"

# ë¬¸ì„œí™”
documentation:
  - file: "docs/api/api-integration-spec.md"
    description: "API í†µí•© ìŠ¤í™"
  - file: "docs/api/api-integration-guide.md"
    description: "ì‹¤í–‰ ê°€ì´ë“œ"
  - file: "docs/category-sync-guide.md"
    description: "ì¹´í…Œê³ ë¦¬ ë™ê¸°í™” ê°€ì´ë“œ"

# ì‹¤í–‰ ì˜ˆì‹œ
examples:
  - name: "Phase 1 ì‹¤í–‰"
    command: "npx claude-flow@alpha workflow run api-integration --phase 1"

  - name: "Phase 2 ì‹¤í–‰"
    command: "npx claude-flow@alpha workflow run api-integration --phase 2"

  - name: "ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰"
    command: "npx claude-flow@alpha workflow run api-integration --all"
