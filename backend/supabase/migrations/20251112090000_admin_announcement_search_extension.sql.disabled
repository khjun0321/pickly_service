-- ============================================
-- Migration: Admin Announcement Search Extension
-- PRD v9.12.0 - Thumbnails, Featured Sections & Search (with Pipes)
-- Purpose: Enable thumbnail uploads, home featured sections, and full-text search with category sync pipes
-- Date: 2025-11-12
-- ============================================

-- ============================================
-- 1ï¸âƒ£ Extend announcements table: thumbnail, featured, tags, search
-- ============================================

-- Add new columns for thumbnail and featured display
ALTER TABLE public.announcements
  ADD COLUMN IF NOT EXISTS thumbnail_url TEXT,
  ADD COLUMN IF NOT EXISTS is_featured BOOLEAN DEFAULT FALSE,
  ADD COLUMN IF NOT EXISTS featured_section TEXT,
  ADD COLUMN IF NOT EXISTS featured_order INT DEFAULT 0,
  ADD COLUMN IF NOT EXISTS tags TEXT[] DEFAULT '{}';

-- Add generated TSVECTOR column for full-text search
-- searchable_text combines title (weight A), organization (weight B), and tags (weight C)
ALTER TABLE public.announcements
  ADD COLUMN IF NOT EXISTS searchable_text TSVECTOR
  GENERATED ALWAYS AS (
    setweight(to_tsvector('simple', coalesce(title,'')), 'A') ||
    setweight(to_tsvector('simple', coalesce(organization,'')), 'B') ||
    setweight(to_tsvector('simple', array_to_string(tags, ' ')), 'C')
  ) STORED;

-- Create indexes for performance
CREATE INDEX IF NOT EXISTS idx_announcements_is_featured
ON public.announcements(is_featured)
WHERE is_featured = true;

CREATE INDEX IF NOT EXISTS idx_announcements_featured_section_order
ON public.announcements(featured_section, featured_order)
WHERE is_featured = true;

CREATE INDEX IF NOT EXISTS idx_announcements_search_gin
ON public.announcements USING GIN (searchable_text);

CREATE INDEX IF NOT EXISTS idx_announcements_tags_gin
ON public.announcements USING GIN (tags);

-- Add comments for documentation
COMMENT ON COLUMN public.announcements.thumbnail_url IS 'ë¦¬ìŠ¤íŠ¸/í™ˆ ë…¸ì¶œìš© ì¸ë„¤ì¼ ì´ë¯¸ì§€ URL (Supabase Storage)';
COMMENT ON COLUMN public.announcements.is_featured IS 'í™ˆ í™”ë©´ ë“± ì£¼ìš” ì„¹ì…˜ ë…¸ì¶œ ì—¬ë¶€';
COMMENT ON COLUMN public.announcements.featured_section IS 'ë…¸ì¶œ ì„¹ì…˜ êµ¬ë¶„ (ì˜ˆ: home, home_hot, city_gyeonggi)';
COMMENT ON COLUMN public.announcements.featured_order IS 'ë…¸ì¶œ ì„¹ì…˜ ë‚´ ì •ë ¬ ìš°ì„ ìˆœìœ„ (ë‚®ì„ìˆ˜ë¡ ìƒìœ„)';
COMMENT ON COLUMN public.announcements.tags IS 'ê²€ìƒ‰ íƒœê·¸ ë¬¸ìì—´ ë°°ì—´ (ì˜ˆ: [''í–‰ë³µì£¼íƒ'', ''ì²­ë…„'', ''í•˜ë‚¨''])';
COMMENT ON COLUMN public.announcements.searchable_text IS 'ì œëª©/ê¸°ê´€/íƒœê·¸ ê¸°ë°˜ Full-Text Search TSVECTOR (ìë™ ìƒì„±)';

-- ============================================
-- 2ï¸âƒ£ Create search_index table (for cross-entity search expansion)
-- ============================================

CREATE TABLE IF NOT EXISTS public.search_index (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  target_type TEXT NOT NULL,           -- 'announcement', 'benefit_category', etc.
  target_id UUID NOT NULL,
  title TEXT,
  description TEXT,
  tags TEXT[] DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  vector TSVECTOR,
  UNIQUE (target_type, target_id)
);

-- Create GIN index for full-text search on vector column
CREATE INDEX IF NOT EXISTS idx_search_index_vector
ON public.search_index USING GIN(vector);

CREATE INDEX IF NOT EXISTS idx_search_index_target
ON public.search_index(target_type, target_id);

COMMENT ON TABLE public.search_index IS 'í†µí•© ê²€ìƒ‰ ì¸ë±ìŠ¤ í…Œì´ë¸” (ê³µê³ , ì¹´í…Œê³ ë¦¬ ë“± í¬ë¡œìŠ¤ ì—”í„°í‹° ê²€ìƒ‰)';
COMMENT ON COLUMN public.search_index.target_type IS 'ê²€ìƒ‰ ëŒ€ìƒ íƒ€ì… (announcement, benefit_category ë“±)';
COMMENT ON COLUMN public.search_index.target_id IS 'ê²€ìƒ‰ ëŒ€ìƒ ID (announcements.id, benefit_categories.id ë“±)';
COMMENT ON COLUMN public.search_index.vector IS 'Full-Text Search TSVECTOR (title + description + tags)';

-- ============================================
-- 3ï¸âƒ£ Pipe Function: Sync search index for announcement
-- ============================================

CREATE OR REPLACE FUNCTION public.sync_search_index_for_announcement(aid UUID)
RETURNS VOID AS $$
DECLARE
  v_title TEXT;
  v_desc TEXT;
  v_tags TEXT[];
  v_org TEXT;
BEGIN
  -- Fetch announcement data
  SELECT a.title, a.subtitle, a.tags, a.organization
  INTO v_title, v_desc, v_tags, v_org
  FROM public.announcements a
  WHERE a.id = aid;

  -- Skip if announcement not found
  IF v_title IS NULL THEN
    RETURN;
  END IF;

  -- Upsert into search_index
  INSERT INTO public.search_index (
    target_type,
    target_id,
    title,
    description,
    tags,
    vector,
    updated_at
  )
  VALUES (
    'announcement',
    aid,
    v_title,
    v_desc,
    v_tags,
    to_tsvector('simple',
      coalesce(v_title,'') || ' ' ||
      coalesce(v_desc,'') || ' ' ||
      coalesce(v_org,'') || ' ' ||
      array_to_string(v_tags,' ')
    ),
    now()
  )
  ON CONFLICT (target_type, target_id) DO UPDATE
  SET
    title = EXCLUDED.title,
    description = EXCLUDED.description,
    tags = EXCLUDED.tags,
    vector = EXCLUDED.vector,
    updated_at = now();
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

COMMENT ON FUNCTION public.sync_search_index_for_announcement(UUID) IS
'ê³µê³  ê²€ìƒ‰ ì¸ë±ìŠ¤ ë™ê¸°í™” í•¨ìˆ˜ (íŒŒì´í”„): announcements ë³€ê²½ ì‹œ search_index ìë™ ê°±ì‹ ';

-- ============================================
-- 4ï¸âƒ£ Trigger: Auto-sync search index on announcement changes
-- ============================================

DROP TRIGGER IF EXISTS trg_announcements_search_sync ON public.announcements;

CREATE TRIGGER trg_announcements_search_sync
  AFTER INSERT OR UPDATE OF title, subtitle, tags, organization ON public.announcements
  FOR EACH ROW
  EXECUTE FUNCTION public.sync_search_index_for_announcement(NEW.id);

COMMENT ON TRIGGER trg_announcements_search_sync ON public.announcements IS
'ê³µê³  ë³€ê²½ ì‹œ ê²€ìƒ‰ ì¸ë±ìŠ¤ ìë™ ë™ê¸°í™” íŠ¸ë¦¬ê±° (íŒŒì´í”„)';

-- ============================================
-- 5ï¸âƒ£ Pipe Functions: Category changes bump related announcements
-- ============================================

-- Bump announcements when benefit_category changes (wall & pipe pattern)
CREATE OR REPLACE FUNCTION public.bump_announcements_by_category(cat_id UUID)
RETURNS INTEGER AS $$
DECLARE
  cnt INTEGER;
BEGIN
  -- Update announcements that reference this category
  UPDATE public.announcements a
  SET updated_at = now()
  WHERE a.category_id = cat_id;

  GET DIAGNOSTICS cnt = ROW_COUNT;

  RAISE NOTICE 'ì¹´í…Œê³ ë¦¬ ë³€ê²½ìœ¼ë¡œ % ê°œ ê³µê³  updated_at ê°±ì‹ ë¨', cnt;
  RETURN cnt;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION public.bump_announcements_by_category(UUID) IS
'ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹œ ê´€ë ¨ ê³µê³  updated_at ê°±ì‹  (ë²½ & íŒŒì´í”„ íŒ¨í„´)';

-- Bump announcements when benefit_subcategory changes
CREATE OR REPLACE FUNCTION public.bump_announcements_by_subcategory(sub_id UUID)
RETURNS INTEGER AS $$
DECLARE
  cnt INTEGER;
BEGIN
  -- Update announcements that reference this subcategory
  UPDATE public.announcements a
  SET updated_at = now()
  WHERE a.subcategory_id = sub_id;

  GET DIAGNOSTICS cnt = ROW_COUNT;

  RAISE NOTICE 'í•˜ìœ„ì¹´í…Œê³ ë¦¬ ë³€ê²½ìœ¼ë¡œ % ê°œ ê³µê³  updated_at ê°±ì‹ ë¨', cnt;
  RETURN cnt;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION public.bump_announcements_by_subcategory(UUID) IS
'í•˜ìœ„ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹œ ê´€ë ¨ ê³µê³  updated_at ê°±ì‹  (ë²½ & íŒŒì´í”„ íŒ¨í„´)';

-- ============================================
-- 6ï¸âƒ£ Triggers: Category/Subcategory changes trigger announcement bump
-- ============================================

-- Trigger on benefit_categories changes
DROP TRIGGER IF EXISTS trg_benefit_categories_bump ON public.benefit_categories;

CREATE TRIGGER trg_benefit_categories_bump
  AFTER UPDATE OF name, slug, icon_url ON public.benefit_categories
  FOR EACH ROW
  EXECUTE FUNCTION public.bump_announcements_by_category(NEW.id);

COMMENT ON TRIGGER trg_benefit_categories_bump ON public.benefit_categories IS
'ì¹´í…Œê³ ë¦¬ ë³€ê²½ â†’ ê³µê³  ê°±ì‹  â†’ ê²€ìƒ‰ ì¸ë±ìŠ¤ ìë™ ë°˜ì˜ (íŒŒì´í”„ ì²´ì¸)';

-- Trigger on benefit_subcategories changes
DROP TRIGGER IF EXISTS trg_benefit_subcategories_bump ON public.benefit_subcategories;

CREATE TRIGGER trg_benefit_subcategories_bump
  AFTER UPDATE OF name, slug ON public.benefit_subcategories
  FOR EACH ROW
  EXECUTE FUNCTION public.bump_announcements_by_subcategory(NEW.id);

COMMENT ON TRIGGER trg_benefit_subcategories_bump ON public.benefit_subcategories IS
'í•˜ìœ„ì¹´í…Œê³ ë¦¬ ë³€ê²½ â†’ ê³µê³  ê°±ì‹  â†’ ê²€ìƒ‰ ì¸ë±ìŠ¤ ìë™ ë°˜ì˜ (íŒŒì´í”„ ì²´ì¸)';

-- ============================================
-- 7ï¸âƒ£ RPC Function: Manual reindex all announcements
-- ============================================

CREATE OR REPLACE FUNCTION public.reindex_announcements()
RETURNS INTEGER AS $$
DECLARE
  r RECORD;
  cnt INTEGER := 0;
BEGIN
  FOR r IN SELECT id FROM public.announcements LOOP
    PERFORM public.sync_search_index_for_announcement(r.id);
    cnt := cnt + 1;
  END LOOP;

  RAISE NOTICE 'ì „ì²´ ê³µê³  % ê°œ ê²€ìƒ‰ ì¸ë±ìŠ¤ ì¬ìƒì„± ì™„ë£Œ', cnt;
  RETURN cnt;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

COMMENT ON FUNCTION public.reindex_announcements() IS
'ì „ì²´ ê³µê³  ê²€ìƒ‰ ì¸ë±ìŠ¤ ìˆ˜ë™ ì¬ìƒì„± (Admin UIì—ì„œ í˜¸ì¶œ)';

-- ============================================
-- 8ï¸âƒ£ RLS Policies for search_index table
-- ============================================

ALTER TABLE public.search_index ENABLE ROW LEVEL SECURITY;

-- Public read access (for search queries)
DROP POLICY IF EXISTS "search_index_select_public" ON public.search_index;
CREATE POLICY "search_index_select_public"
  ON public.search_index
  FOR SELECT
  USING (true);

-- Authenticated users can insert/update/delete (Admin only)
DROP POLICY IF EXISTS "search_index_write_auth" ON public.search_index;
CREATE POLICY "search_index_write_auth"
  ON public.search_index
  FOR ALL
  TO authenticated
  USING (auth.role() = 'authenticated')
  WITH CHECK (auth.role() = 'authenticated');

-- ============================================
-- 9ï¸âƒ£ Helper Functions for Search Queries
-- ============================================

-- Search announcements by keyword (full-text search)
CREATE OR REPLACE FUNCTION public.search_announcements(
  search_query TEXT,
  result_limit INT DEFAULT 50
)
RETURNS TABLE (
  id UUID,
  title TEXT,
  organization TEXT,
  tags TEXT[],
  thumbnail_url TEXT,
  is_featured BOOLEAN,
  rank REAL
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    a.id,
    a.title,
    a.organization,
    a.tags,
    a.thumbnail_url,
    a.is_featured,
    ts_rank(a.searchable_text, plainto_tsquery('simple', search_query)) AS rank
  FROM public.announcements a
  WHERE a.searchable_text @@ plainto_tsquery('simple', search_query)
  ORDER BY rank DESC, a.created_at DESC
  LIMIT result_limit;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

COMMENT ON FUNCTION public.search_announcements(TEXT, INT) IS
'í‚¤ì›Œë“œ ê¸°ë°˜ ê³µê³  Full-Text ê²€ìƒ‰ (ì œëª©, ê¸°ê´€, íƒœê·¸ í†µí•©)';

-- Get featured announcements by section
CREATE OR REPLACE FUNCTION public.get_featured_announcements(
  section_filter TEXT DEFAULT NULL,
  result_limit INT DEFAULT 20
)
RETURNS TABLE (
  id UUID,
  title TEXT,
  organization TEXT,
  thumbnail_url TEXT,
  featured_section TEXT,
  featured_order INT
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    a.id,
    a.title,
    a.organization,
    a.thumbnail_url,
    a.featured_section,
    a.featured_order
  FROM public.announcements a
  WHERE a.is_featured = true
    AND (section_filter IS NULL OR a.featured_section = section_filter)
  ORDER BY a.featured_order ASC, a.created_at DESC
  LIMIT result_limit;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

COMMENT ON FUNCTION public.get_featured_announcements(TEXT, INT) IS
'í™ˆ ë…¸ì¶œ ê³µê³  ì¡°íšŒ (ì„¹ì…˜ë³„ í•„í„°ë§ ë° ì •ë ¬)';

-- ============================================
-- âœ… Migration Complete
-- ============================================

DO $$
BEGIN
  RAISE NOTICE '==============================================';
  RAISE NOTICE 'âœ… PRD v9.12.0 Migration Complete';
  RAISE NOTICE '==============================================';
  RAISE NOTICE 'ğŸ“Š Added Columns:';
  RAISE NOTICE '   - announcements: thumbnail_url, is_featured, featured_section, featured_order, tags, searchable_text';
  RAISE NOTICE 'ğŸ“‹ Created Tables:';
  RAISE NOTICE '   - search_index (í†µí•© ê²€ìƒ‰ ì¸ë±ìŠ¤)';
  RAISE NOTICE 'ğŸ” Created Indexes:';
  RAISE NOTICE '   - 4 GIN indexes for full-text search';
  RAISE NOTICE 'ğŸ”„ Created Functions:';
  RAISE NOTICE '   - sync_search_index_for_announcement()';
  RAISE NOTICE '   - bump_announcements_by_category()';
  RAISE NOTICE '   - bump_announcements_by_subcategory()';
  RAISE NOTICE '   - reindex_announcements()';
  RAISE NOTICE '   - search_announcements()';
  RAISE NOTICE '   - get_featured_announcements()';
  RAISE NOTICE 'ğŸ”— Created Triggers:';
  RAISE NOTICE '   - trg_announcements_search_sync';
  RAISE NOTICE '   - trg_benefit_categories_bump';
  RAISE NOTICE '   - trg_benefit_subcategories_bump';
  RAISE NOTICE 'ğŸ”’ RLS Policies:';
  RAISE NOTICE '   - search_index: public read, authenticated write';
  RAISE NOTICE '==============================================';
  RAISE NOTICE 'ğŸ“ Next Steps:';
  RAISE NOTICE '   1. Create announcement-thumbnails Storage bucket';
  RAISE NOTICE '   2. Implement Admin UI components';
  RAISE NOTICE '   3. Run reindex_announcements() to populate search_index';
  RAISE NOTICE '==============================================';
END $$;
