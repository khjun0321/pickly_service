name: ðŸ”„ Pickly Data Sync Pipeline

# PRD v9.6.1 - Phase 4D Step 2
# Automated API Collection and Data Transformation

on:
  # Scheduled execution: Daily at 3:00 AM KST (18:00 UTC)
  schedule:
    - cron: '0 18 * * *'

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (test without DB writes)'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '22'
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

jobs:
  data-sync:
    name: API Collection & Transformation
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ========================================
      # Step 1: Checkout Repository
      # ========================================
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ========================================
      # Step 2: Setup Node.js Environment
      # ========================================
      - name: ðŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      # ========================================
      # Step 3: Install Dependencies
      # ========================================
      - name: ðŸ“¦ Install Dependencies
        working-directory: ./backend
        run: |
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed successfully"

      # ========================================
      # Step 4: Verify Environment
      # ========================================
      - name: ðŸ” Verify Environment Variables
        working-directory: ./backend
        run: |
          echo "Checking required environment variables..."

          if [ -z "$SUPABASE_URL" ]; then
            echo "âŒ ERROR: SUPABASE_URL is not set"
            exit 1
          fi

          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ] && [ -z "$SUPABASE_ANON_KEY" ]; then
            echo "âŒ ERROR: Neither SUPABASE_SERVICE_ROLE_KEY nor SUPABASE_ANON_KEY is set"
            exit 1
          fi

          echo "âœ… SUPABASE_URL: ${SUPABASE_URL}"
          echo "âœ… Environment variables verified"

      # ========================================
      # Step 5: API Collection
      # ========================================
      - name: ðŸ“¡ Run API Collection
        id: collect
        working-directory: ./backend
        run: |
          echo "Starting API collection..."
          START_TIME=$(date +%s)

          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ðŸ§ª Running in DRY RUN mode"
            npm run collect:api:dry-run
          else
            npm run collect:api
          fi

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo "âœ… API Collection completed in ${DURATION}s"
          echo "duration=${DURATION}" >> $GITHUB_OUTPUT
        continue-on-error: false

      # ========================================
      # Step 6: Data Transformation
      # ========================================
      - name: ðŸ”„ Run Data Transformation
        id: transform
        working-directory: ./backend
        run: |
          echo "Starting data transformation..."
          START_TIME=$(date +%s)

          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ðŸ§ª Running in DRY RUN mode"
            npm run transform:api:dry-run
          else
            npm run transform:api
          fi

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo "âœ… Data Transformation completed in ${DURATION}s"
          echo "duration=${DURATION}" >> $GITHUB_OUTPUT
        continue-on-error: false

      # ========================================
      # Step 7: Upload Logs as Artifacts
      # ========================================
      - name: ðŸ“‹ Upload Execution Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: execution-logs-${{ github.run_number }}
          path: |
            backend/logs/*.log
          retention-days: 30
          if-no-files-found: warn

      # ========================================
      # Step 8: Generate Summary Report
      # ========================================
      - name: ðŸ“Š Generate Summary Report
        if: always()
        run: |
          echo "## ðŸ”„ Pickly Data Sync Pipeline - Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow**: \`${{ github.workflow }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Run Number**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered By**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run**: ${{ inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â±ï¸ Execution Times" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Duration | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| API Collection | ${{ steps.collect.outputs.duration }}s | ${{ steps.collect.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Data Transformation | ${{ steps.transform.outputs.duration }}s | ${{ steps.transform.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Execution logs uploaded as artifact: \`execution-logs-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Retention: 30 days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.collect.outcome }}" = "success" ] && [ "${{ steps.transform.outcome }}" = "success" ]; then
            echo "### âœ… Result: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All pipeline steps completed successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Result: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more pipeline steps failed. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi

      # ========================================
      # Step 9: Notify on Failure (Optional)
      # ========================================
      - name: ðŸš¨ Notify on Failure
        if: failure()
        run: |
          echo "âš ï¸ Pipeline failed! Check the logs for details."
          echo "Failed step: ${{ job.status }}"
          echo "Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Future: Add Slack/Email notification here
          # Example:
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"Pickly Data Sync Pipeline Failed!"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

  # ========================================
  # Job: Verify Database Updates (Optional)
  # ========================================
  verify-results:
    name: Verify Database Updates
    runs-on: ubuntu-latest
    needs: data-sync
    if: success() && github.event.inputs.dry_run != 'true'
    timeout-minutes: 5

    steps:
      - name: ðŸ“Š Database Verification Summary
        run: |
          echo "## ðŸ“Š Database Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Data sync completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Check Supabase dashboard for new announcements" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify raw_announcements status = 'processed'" >> $GITHUB_STEP_SUMMARY
          echo "3. Review execution logs artifact for details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Database queries** (run locally):" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`sql" >> $GITHUB_STEP_SUMMARY
          echo "-- Check recent announcements" >> $GITHUB_STEP_SUMMARY
          echo "SELECT id, title, organization, created_at" >> $GITHUB_STEP_SUMMARY
          echo "FROM announcements" >> $GITHUB_STEP_SUMMARY
          echo "ORDER BY created_at DESC LIMIT 10;" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "-- Check processing status" >> $GITHUB_STEP_SUMMARY
          echo "SELECT status, COUNT(*) FROM raw_announcements GROUP BY status;" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
